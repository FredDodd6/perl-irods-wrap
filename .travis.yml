language: perl

perl:
  - "5.16"

addons:
  postgresql: "9.3"

env:
  global:
    - PGVERSION="9.3"
    - CK_DEFAULT_TIMEOUT=10
    - IRODS_VAULT=/usr/local/var/lib/irods/Vault

before_install:
- sudo apt-get update -qq
- sudo apt-get install -qq odbc-postgresql unixodbc-dev

install:
  - cpanm --quiet --notest Cache::MemoryCache
  - cpanm --quiet --notest Log::Log4perl
  - cpanm --quiet --notest Moose

before_script:
  - wget -q https://github.com/akheron/jansson/archive/v2.6.tar.gz -O /tmp/jansson-2.6.tar.gz
  - tar xfz /tmp/jansson-2.6.tar.gz -C /tmp
  - cd /tmp/jansson-2.6 ; autoreconf -fi ; ./configure ; make ; sudo make install
  - wget -q https://github.com/wtsi-npg/irods-legacy/releases/download/3.3.1-travis-bc85aa/irods.tar.gz -O /tmp/irods.tar.gz
  - tar xfz /tmp/irods.tar.gz
  - source $TRAVIS_BUILD_DIR/travis_linux_env.sh
  - wget -q https://github.com/wtsi-npg/baton/releases/download/0.11.1/baton-0.11.1.tar.gz -O /tmp/baton-0.11.1.tar.gz
  - tar xfz /tmp/baton-0.11.1.tar.gz -C /tmp
  - cd /tmp/baton-0.11.1 ; ./configure --with-irods=$IRODS_HOME ; make ; sudo make install
  - export PATH=$PATH:$IRODS_HOME/clients/icommands/bin
  - sudo mkdir -p $IRODS_VAULT
  - sudo chown $USER:$USER $IRODS_VAULT
  - sudo -E -u postgres $TRAVIS_BUILD_DIR/setup_pgusers.sh
  - sudo -E -u postgres $TRAVIS_BUILD_DIR/irodscontrol psetup
  - $TRAVIS_BUILD_DIR/irodscontrol istart ; sleep 10
  - echo irods | script -q -c "iinit" > /dev/null
  - ienv
  - ils

script:
  - perl Build.PL
  - ./Build clean
  - ./Build test

after_script:
  - $TRAVIS_BUILD_DIR/irodscontrol istop
